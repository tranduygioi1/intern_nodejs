<div class="container py-4">
  <h2 class="mb-4">
    <i class="bx bx-news text-primary"></i> News Feed
  </h2>

  <!-- FORM ĐĂNG BÀI -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form id="postForm" action="/news/create" method="POST" enctype="multipart/form-data">
        <div class="d-flex align-items-start mb-3">
          {{#if user.avatar}}
            <img src="{{user.avatar}}" alt="Avatar" class="rounded-circle me-3"
                 style="width: 50px; height: 50px; object-fit: cover;">
          {{else}}
            <div class="rounded-circle text-white d-flex align-items-center justify-content-center me-3"
                 style="width: 50px; height: 50px; font-weight: bold; background-color: #0072bc;">
              {{user.name.[0]}}
            </div>
          {{/if}}

          <textarea class="form-control" name="content" rows="3"
                    placeholder="Bạn đang nghĩ gì thế, {{user.name}}?" required></textarea>
        </div>

        <input type="hidden" name="type" id="postType" value="text">
        <input type="file" name="media" id="fileInput" class="d-none" accept="image/*,video/*">

        <!-- Hiển thị preview -->
        <div id="mediaPreview" class="mt-3"></div>

        <div class="d-flex justify-content-between align-items-center border-top pt-3 flex-wrap gap-2">
          <span class="text-muted">Thêm vào bài viết của bạn:</span>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-light border" id="addPhotoBtn">
              <i class="bx bx-image text-success"></i> Ảnh
            </button>
            <button type="button" class="btn btn-light border" id="addVideoBtn">
              <i class="bx bx-video text-danger"></i> Video
            </button>
            <button type="submit" class="btn text-white" style="background-color: #0072bc;">
              <i class="bx bx-send"></i> Đăng
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>  

  <!-- DANH SÁCH BÀI VIẾT -->
  {{#if posts.length}}
    {{#each posts}}
      <div class="card mb-4 shadow-sm position-relative">
        <div class="card-body">

          <!-- Header bài viết -->
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="d-flex align-items-center">
              {{#if this.author.avatar}}
                <img src="{{this.author.avatar}}" alt="avatar" class="rounded-circle me-2"
                     style="width: 40px; height: 40px; object-fit: cover;">
              {{else}}
                <div class="rounded-circle text-white d-flex align-items-center justify-content-center me-2"
                     style="width: 40px; height: 40px; background-color:#0072bc; font-weight: bold;">
                  {{this.author.name.[0]}}
                </div>
              {{/if}}

              <div>
                <strong>{{this.author.name}}</strong><br>
                <small class="text-muted">{{formatDate this.createdAt}}</small>
              </div>
            </div>

            <!-- Nút 3 chấm (chỉ hiện nếu là bài của chính user) -->
            {{#if (eq this.author._id ../user._id)}}
              <div class="dropdown">
                <button class="btn btn-light btn-sm border-0" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bx bx-dots-horizontal-rounded fs-4"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                  <li>
                    <form action="/news/delete/{{this._id}}" method="POST"
                          onsubmit="return confirm('Bạn có chắc muốn xóa bài viết này?');">
                      <button type="submit" class="dropdown-item text-danger">
                        <i class="bx bx-trash me-2"></i> Xóa bài viết
                      </button>
                    </form>
                  </li>
                </ul>
              </div>
            {{/if}}
          </div>

          <!-- Nội dung -->
          <p class="mb-3">{{this.content}}</p>

          {{#if (eq this.type "image")}}
            <div class="text-center">
              <img src="{{this.mediaUrl}}" alt="post image" 
                  class="img-fluid rounded shadow-sm mb-3"
                  style="max-width: 500px; height: auto; border-radius: 10px;">
            </div>
          {{/if}}

          {{#if (eq this.type "video")}}
            <div class="text-center">
              <video controls 
                    style="max-width: 500px; height: auto; border-radius: 10px;" 
                    class="shadow-sm mb-3">
                <source src="{{this.mediaUrl}}" type="video/mp4">
              </video>
            </div>
          {{/if}}

          <!-- Nhãn quyền xem -->
          <p class="text-muted small">
            <i class="bx bx-group"></i> Chỉ bạn bè có thể xem bài viết này
          </p>

        </div>
      </div>
    {{/each}}
  {{else}}
    <p class="text-muted text-center mt-5">Chưa có bài viết nào.</p>
  {{/if}}
</div>

<script>
  const fileInput = document.getElementById('fileInput');
  const postTypeInput = document.getElementById('postType');
  const addPhotoBtn = document.getElementById('addPhotoBtn');
  const addVideoBtn = document.getElementById('addVideoBtn');
  const mediaPreview = document.getElementById('mediaPreview');

  addPhotoBtn.addEventListener('click', () => {
    postTypeInput.value = 'image';
    fileInput.accept = 'image/*';
    fileInput.click();
  });

  addVideoBtn.addEventListener('click', () => {
    postTypeInput.value = 'video';
    fileInput.accept = 'video/*';
    fileInput.click();
  });

  // Xem trước file
  fileInput.addEventListener('change', () => {
    mediaPreview.innerHTML = '';
    const file = fileInput.files[0];
    if (!file) return;

    const url = URL.createObjectURL(file);
    if (file.type.startsWith('image/')) {
      const img = document.createElement('img');
      img.src = url;
      img.className = 'img-fluid rounded shadow-sm';
      img.style.maxHeight = '300px';
      mediaPreview.appendChild(img);
    } else if (file.type.startsWith('video/')) {
      const video = document.createElement('video');
      video.src = url;
      video.controls = true;
      video.className = 'w-100 rounded shadow-sm';
      video.style.maxHeight = '400px';
      mediaPreview.appendChild(video);
    }
  });
</script>
