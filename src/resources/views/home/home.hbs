<h2>Quản lý User</h2>

<!-- ======================== FORM THÊM / CẬP NHẬT USER ======================== -->
{{#if (includes userPermissions "add_user")}}
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-primary text-white">
    <i class="bx bx-user-plus"></i> Thêm / Cập nhật User
  </div>
  <div class="card-body">
    <form id="userForm" action="/home/add-user" method="POST">
      <div class="input-group input-group-sm">
        <span class="input-group-text fw-bold">User</span>
        <input type="text" name="name" id="name" class="form-control" placeholder="Tên" required>
        <input type="text" name="username" id="username" class="form-control" placeholder="Username" required>
        <input type="text" name="department" id="department" class="form-control" placeholder="Phòng ban" required>
        <input type="email" name="email" id="email" class="form-control" placeholder="Email" required>
        <input type="password" name="password" id="password" class="form-control" placeholder="Mật khẩu" required>
        <button type="submit" id="submitBtn" class="btn btn-success">
          <i class="bx bx-save"></i> Thêm
        </button>
      </div>
    </form>
  </div>
</div>
{{/if}}

<!-- ======================== DANH SÁCH USER ======================== -->
<div class="card shadow-sm">
  <div class="card-header bg-dark text-white">
    <i class="bx bx-list-ul"></i> Danh sách User
  </div>
  <div class="card-body p-0">
    <table class="table table-striped table-bordered mb-0">
      <thead class="table-dark">
        <tr>
          <th style="background:#009BDF;color:#fff;">#</th>
          <th style="background:#009BDF;color:#fff;">Tên</th>
          <th style="background:#009BDF;color:#fff;">Username</th>
          <th style="background:#009BDF;color:#fff;">Phòng ban</th>
          <th style="background:#009BDF;color:#fff;">Email</th>
          <th style="background:#009BDF;color:#fff;" class="text-center">Hành động</th>
        </tr>
      </thead>
      <tbody>
        {{#each users}}
        <tr>
          <td>{{sum @index 1}}</td>
          <td>{{this.name}}</td>
          <td>{{this.username}}</td>
          <td>{{this.department}}</td>
          <td>{{this.email}}</td>
          <td class="text-center">

            <!-- Nút Sửa (chỉ hiện nếu có quyền update_user) -->
            {{#if (includes ../userPermissions "update_user")}}
              <button type="button" class="btn btn-primary btn-sm editBtn"
                      data-id="{{this._id}}"
                      data-name="{{this.name}}"
                      data-username="{{this.username}}"
                      data-department="{{this.department}}"
                      data-email="{{this.email}}">
                <i class="bx bx-edit"></i> Sửa
              </button>
            {{/if}}

            <!-- Nút Xóa (chỉ hiện nếu có quyền delete_user) -->
            {{#if (includes ../userPermissions "delete_user")}}
              <form action="/home/delete-user/{{this._id}}" method="POST" style="display:inline-block">
                <button type="submit" class="btn btn-danger btn-sm">
                  <i class="bx bx-trash"></i> Xóa
                </button>
              </form>
            {{/if}}

          </td>
        </tr>
        {{/each}}
      </tbody>
    </table>
  </div>
</div>

<!-- ======================== SCRIPT SỬA USER ======================== -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("userForm");
    const submitBtn = document.getElementById("submitBtn");
    const passwordInput = document.getElementById("password");

    document.querySelectorAll(".editBtn").forEach(btn => {
      btn.addEventListener("click", function () {
        const id = this.getAttribute("data-id");
        const name = this.getAttribute("data-name");
        const username = this.getAttribute("data-username");
        const department = this.getAttribute("data-department");
        const email = this.getAttribute("data-email");

        document.getElementById("name").value = name;
        document.getElementById("username").value = username;
        document.getElementById("department").value = department;
        document.getElementById("email").value = email;

        passwordInput.value = "********";
        passwordInput.disabled = true;

        submitBtn.innerHTML = '<i class="bx bx-refresh"></i> Cập nhật';
        submitBtn.classList.remove("btn-success");
        submitBtn.classList.add("btn-warning");

        form.action = `/home/update-user/${id}`;
      });
    });
  });
</script>
